<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SCA Cupping – ฟอร์มประเมินกาแฟ (Professional V5)</title>
<style>
/* --- Color Variables --- */
:root {
  --background-color: #0d1117;
  --card-background: #161b22;
  --header-background: #1f2a37;
  --border-color: #30363d;
  --text-color: #c9d1d9;
  --heading-color: #f0f6fc;
  --accent-color: #58a6ff;
  --score-color: #238636; /* Green for Specialty Score */
  --low-score-color: #DA3633; /* Red for Not Specialty */
  --range-thumb-color: #38b44a;
  --shadow-color: rgba(0,0,0,0.4);
}

/* Base Styles & Dark Theme */
body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--background-color);
    color: var(--text-color);
}
header {
    background: var(--header-background);
    padding: 18px 24px;
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 4px 8px var(--shadow-color);
}
h1 {
    margin: 0;
    font-size: 26px;
    color: var(--heading-color);
    font-weight: 600;
}
.wrap {
    max-width: 900px;
    margin: auto;
    padding: 20px;
}
.card {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 28px;
    box-shadow: 0 6px 15px var(--shadow-color);
}
h2 {
    margin: 0 0 12px 0;
    font-size: 22px;
    color: var(--accent-color);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 10px;
    font-weight: 600;
}
p.hint {
    font-size: 14px;
    color: #8B949E;
    margin: 0 0 16px 0;
}
label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 16px;
    color: var(--heading-color);
}
input[type=text], input[type=number], textarea, select {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: var(--background-color);
    color: var(--text-color);
    box-sizing: border-box;
    margin-bottom: 16px;
    transition: border-color 0.3s, box-shadow 0.3s;
    font-size: 16px;
}
input:focus, textarea:focus, select:focus {
    border-color: var(--accent-color);
    outline: none;
    box-shadow: 0 0 0 2px var(--accent-color);
}

.input-group {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}
.input-group textarea {
    flex-grow: 1;
    margin-bottom: 0;
}
.input-group .btn-vocab {
    min-width: 120px;
    font-size: 14px;
    padding: 12px;
    background: var(--accent-color);
    color: #fff;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
}
.input-group .btn-vocab:hover {
    background: #79C0FF;
}

.row {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 20px;
    align-items: center;
    margin-top: 10px;
    margin-bottom: 20px;
}
.row input[type=number] {
    width: 100%;
    max-width: 120px;
    margin-bottom: 0;
    text-align: center;
}
.row input[type=range] {
    height: 12px;
    background: #30363D;
    border-radius: 6px;
    -webkit-appearance: none;
    appearance: none;
    margin: 0;
    padding: 0;
}
.row input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--range-thumb-color);
    cursor: pointer;
    box-shadow: 0 0 4px var(--shadow-color);
    transition: background-color 0.3s;
}
.row input[type=range]::-webkit-slider-thumb:hover {
    background: #47d65f;
}
.row input[type=range]::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border: none;
    border-radius: 50%;
    background: var(--range-thumb-color);
    cursor: pointer;
}

.btn {
    padding: 14px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    width: 100%;
    transition: background-color 0.3s, transform 0.1s;
    font-size: 16px;
    margin-top: 5px;
}
.btn:active {
    transform: translateY(1px);
}
.btn-primary {background: var(--score-color);color: #fff;}
.btn-primary:hover {background: #2EA043;}
.btn-danger {background: var(--low-score-color);color: #fff;}
.btn-danger:hover {background: #F85149;}
.btn-export {background: var(--accent-color);color: #fff;}
.btn-export:hover {background: #79C0FF;}
.btn-text-copy {background: #F6F8FA;color: var(--card-background);}
.btn-text-copy:hover {background: #e8eaec;}

.hidden {display: none;}

/* Corrected Checkbox Layout */
.cup-checks {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    margin-top: 10px;
    padding: 10px 0;
    border-top: 1px solid var(--border-color);
    border-bottom: 1px solid var(--border-color);
    justify-content: space-between;
}
.cup-checks div {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
}
.cup-checks input[type=checkbox] {
    width: 20px;
    height: 20px;
    margin: 0;
    cursor: pointer;
    background-color: #30363D;
    border: 2px solid #8B949E;
    border-radius: 6px;
    -webkit-appearance: none;
    appearance: none;
    vertical-align: middle;
    transition: background-color 0.3s, border-color 0.3s;
}
.cup-checks input[type=checkbox]:checked {
    background-color: var(--score-color);
    border-color: var(--score-color);
}
.cup-checks label {
    margin-bottom: 0;
    font-weight: normal;
}

/* Defects */
#defectDynamic > div {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}
#defectDynamic label {
    flex-basis: 140px;
    margin-bottom: 0;
}
#defectDynamic select {
    flex-grow: 1;
    max-width: 120px;
    margin-bottom: 0;
}

/* Summary Page Styling */
.summary-container {display: flex;flex-direction: column;gap: 24px;}
.summary-card {
    background: var(--card-background);
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 6px 15px var(--shadow-color);
    border: 1px solid var(--border-color);
}
.summary-card h2, .summary-card h3 {margin-top: 0;color: var(--accent-color);}
.summary-header {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 16px;
    color: var(--heading-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}
.summary-score {
    font-size: 64px;
    font-weight: bold;
    color: var(--score-color);
    margin: 16px 0 10px 0;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.6);
}
.grade-tag {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    padding: 6px 14px;
    border-radius: 8px;
    display: inline-block;
    background: var(--low-score-color);
}
.summary-text {
    font-size: 16px;
    color: #8B949E;
    margin-top: 12px;
    line-height: 1.6;
}

/* Summary Table/Grid Layout - Reverted to actual table for guaranteed compatibility */
.summary-table {
  width: 100%;
  margin-top: 20px;
  border-collapse: collapse;
  border: 1px solid var(--border-color);
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.summary-table th, .summary-table td {
  padding: 14px;
  word-wrap: break-word;
  white-space: pre-wrap;
  border: 1px solid var(--border-color);
  text-align: left;
}
.summary-table th {
  background: var(--border-color);
  color: var(--heading-color);
  font-weight: 600;
}
.summary-table tr:nth-child(even) {
  background: #161b22;
}
.summary-table tr:nth-child(odd) {
  background: #0d1117;
}

/* General Info Card in Summary */
.summary-card p {
    margin: 8px 0;
    font-size: 16px;
}
.summary-card b {
    color: var(--accent-color);
    font-weight: 600;
}
.summary-card span {
  font-size: 16px;
}
/* Export Buttons Layout */
.export-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 15px;
}
.export-buttons .btn {
  flex: 1;
  min-width: 150px;
}

/* --- Modal Styles (NEW) --- */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}
.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}
.modal-content {
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: transform 0.3s;
}
.modal-overlay.active .modal-content {
    transform: scale(1);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 12px;
    margin-bottom: 16px;
}
.modal-header h3 {
    margin: 0;
    color: var(--heading-color);
    font-size: 20px;
}
.modal-close {
    background: none;
    border: none;
    color: var(--text-color);
    font-size: 24px;
    cursor: pointer;
}
.vocab-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
}
.vocab-category-btn {
    padding: 10px 16px;
    background: var(--border-color);
    color: var(--text-color);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s;
    font-weight: bold;
}
.vocab-category-btn.active {
    background: var(--accent-color);
    color: #fff;
}
.vocab-words {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}
.vocab-word-item {
    padding: 8px 12px;
    background: var(--background-color);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s, border-color 0.2s;
}
.vocab-word-item:hover {
    background: #30363d;
}
</style>
</head>
<body>
<header>
<h1>SCA Cupping – ฟอร์มประเมินกาแฟ</h1>
</header>
<main class="wrap">
<div id="formPage">
  <div class="card">
    <h2>ข้อมูลตัวอย่าง</h2>
    <label for="sampleId">หมายเลขตัวอย่าง (Sample #)</label>
    <input type="text" id="sampleId" placeholder="เช่น A-01">
    
    <label for="roast">ระดับการคั่ว</label>
    <select id="roast">
      <option>Light</option>
      <option>Medium</option>
      <option>Dark</option>
    </select>
    
    
    <label for="notes">หมายเหตุ</label>
    <textarea id="notes" rows="3" placeholder="รายละเอียดเพิ่มเติมเกี่ยวกับตัวอย่าง"></textarea>
  </div>

  <div class="card">
    <h2>Fragrance/Aroma</h2>
    <p class="hint">กลิ่นหอมแห้ง (Fragrance) + กลิ่นเมื่อเติมน้ำร้อน (Aroma)</p>
    <div class="row">
      <input type="number" id="fragranceScore" min="6" max="10" step="0.25" value="10">
      <input type="range" id="fragranceRange" min="6" max="10" step="0.25" value="10">
    </div>
    <label for="fragranceNote">บันทึกสิ่งที่เจอใน Fragrance</label>
    <div class="input-group">
      <textarea id="fragranceNote" rows="2" placeholder="บันทึกกลิ่นเมื่อยังเป็นผงกาแฟ"></textarea>
      <button class="btn-vocab" data-target="fragranceNote"> + เพิ่มคำศัพท์ </button>
    </div>
    <label for="aromaNote">บันทึกสิ่งที่เจอใน Aroma</label>
    <div class="input-group">
      <textarea id="aromaNote" rows="2" placeholder="บันทึกกลิ่นหลังจากเติมน้ำร้อน"></textarea>
      <button class="btn-vocab" data-target="aromaNote"> + เพิ่มคำศัพท์ </button>
    </div>
  </div>

  <div class="card">
    <h2>Flavor</h2>
    <p class="hint">รสชาติรวมและความซับซ้อน</p>
    <div class="row">
      <input type="number" id="flavorScore" min="6" max="10" step="0.25" value="10">
      <input type="range" id="flavorRange" min="6" max="10" step="0.25" value="10">
    </div>
    <label for="flavorNote">บันทึกสิ่งที่เจอใน Flavor</label>
    <div class="input-group">
      <textarea id="flavorNote" rows="3" placeholder="บันทึกสิ่งที่เจอใน Flavor"></textarea>
      <button class="btn-vocab" data-target="flavorNote"> + เพิ่มคำศัพท์ </button>
    </div>
  </div>
  
  <div class="card">
    <h2>Aftertaste</h2>
    <p class="hint">รสชาติที่ค้างอยู่หลังดื่ม</p>
    <div class="row">
      <input type="number" id="aftertasteScore" min="6" max="10" step="0.25" value="10">
      <input type="range" id="aftertasteRange" min="6" max="10" step="0.25" value="10">
    </div>
    <label for="aftertasteNote">บันทึกสิ่งที่เจอใน Aftertaste</label>
    <div class="input-group">
      <textarea id="aftertasteNote" rows="3" placeholder="บันทึกสิ่งที่เจอใน Aftertaste"></textarea>
      <button class="btn-vocab" data-target="aftertasteNote"> + เพิ่มคำศัพท์ </button>
    </div>
  </div>

  <div class="card">
    <h2>Acidity</h2>
    <p class="hint">ความเป็นกรด</p>
    <div class="row">
      <input type="number" id="acidityScore" min="6" max="10" step="0.25" value="10">
      <input type="range" id="acidityRange" min="6" max="10" step="0.25" value="10">
    </div>
    <label for="acidityLevel">Acidity Level</label>
    <select id="acidityLevel">
      <option value="">--เลือกระดับความเป็นกรด--</option>
      <option>Low</option>
      <option>Medium</option>
      <option>High</option>
    </select>

    <label for="acidityNote">บันทึกสิ่งที่เจอใน Acidity</label>
    <div class="input-group">
      <textarea id="acidityNote" rows="3" placeholder="บันทึกสิ่งที่เจอใน Acidity"></textarea>
      <button class="btn-vocab" data-target="acidityNote"> + เพิ่มคำศัพท์ </button>
    </div>
  </div>
  
  <div class="card">
    <h2>Body</h2>
    <p class="hint">ความหนักแน่น/เนื้อสัมผัส</p>
    <div class="row">
      <input type="number" id="bodyScore" min="6" max="10" step="0.25" value="10">
      <input type="range" id="bodyRange" min="6" max="10" step="0.25" value="10">
    </div>
    <label for="bodyNote">บันทึกสิ่งที่เจอใน Body</label>
    <div class="input-group">
      <textarea id="bodyNote" rows="3" placeholder="บันทึกว่าเนื้อสัมผัสของกาแฟเป็นอย่างไร"></textarea>
      <button class="btn-vocab" data-target="bodyNote"> + เพิ่มคำศัพท์ </button>
    </div>
  </div>

  <div class="card">
    <h2>Balance</h2>
    <p class="hint">ความกลมกลืนขององค์ประกอบ</p>
    <div class="row">
      <input type="number" id="balanceScore" min="6" max="10" step="0.25" value="10">
      <input type="range" id="balanceRange" min="6" max="10" step="0.25" value="10">
    </div>
    <label for="balanceNote">บันทึกสิ่งที่เจอใน Balance</label>
    <div class="input-group">
      <textarea id="balanceNote" rows="3" placeholder="บันทึกความเป็นสมดุลของกาแฟว่าเป็นอย่างไร"></textarea>
      <button class="btn-vocab" data-target="balanceNote"> + เพิ่มคำศัพท์ </button>
    </div>
  </div>

  <div class="card">
    <h2>Uniformity</h2>
    <p class="hint">ความสม่ำเสมอระหว่างถ้วย : (ถ้า check จะถือว่าไม่สม่ำเสมอ)</p>
    <div class="cup-checks">
      <div><input type="checkbox" id="uniformity1"><label for="uniformity1">แก้ว 1</label></div>
      <div><input type="checkbox" id="uniformity2"><label for="uniformity2">แก้ว 2</label></div>
      <div><input type="checkbox" id="uniformity3"><label for="uniformity3">แก้ว 3</label></div>
      <div><input type="checkbox" id="uniformity4"><label for="uniformity4">แก้ว 4</label></div>
      <div><input type="checkbox" id="uniformity5"><label for="uniformity5">แก้ว 5</label></div>
    </div>
  </div>

  <div class="card">
    <h2>Clean Cup</h2>
    <p class="hint">ความใสสะอาด ปราศจาก off-flavor : (ถ้า check จะถือว่าไม่ใสสะอาด)</p>
    <div class="cup-checks">
      <div><input type="checkbox" id="cleanCup1"><label for="cleanCup1">แก้ว 1</label></div>
      <div><input type="checkbox" id="cleanCup2"><label for="cleanCup2">แก้ว 2</label></div>
      <div><input type="checkbox" id="cleanCup3"><label for="cleanCup3">แก้ว 3</label></div>
      <div><input type="checkbox" id="cleanCup4"><label for="cleanCup4">แก้ว 4</label></div>
      <div><input type="checkbox" id="cleanCup5"><label for="cleanCup5">แก้ว 5</label></div>
    </div>
  </div>

  <div class="card">
    <h2>Sweetness</h2>
    <p class="hint">ความหวานธรรมชาติ : (ถ้า check จะถือว่าไม่มีความหวาน)</p>
    <div class="cup-checks">
      <div><input type="checkbox" id="sweetness1"><label for="sweetness1">แก้ว 1</label></div>
      <div><input type="checkbox" id="sweetness2"><label for="sweetness2">แก้ว 2</label></div>
      <div><input type="checkbox" id="sweetness3"><label for="sweetness3">แก้ว 3</label></div>
      <div><input type="checkbox" id="sweetness4"><label for="sweetness4">แก้ว 4</label></div>
      <div><input type="checkbox" id="sweetness5"><label for="sweetness5">แก้ว 5</label></div>
    </div>
  </div>

  <div class="card">
    <h2>Overall</h2>
    <p class="hint">ความประทับใจรวม</p>
    <div class="row">
      <input type="number" id="overallScore" min="6" max="10" step="0.25" value="10">
      <input type="range" id="overallRange" min="6" max="10" step="0.25" value="10">
    </div>
    <label for="overallNote">บันทึกความประทับใจรวม</label>
    <div class="input-group">
      <textarea id="overallNote" rows="3" placeholder="บันทึกความรู้สึกหรือสิ่งที่โดดเด่น"></textarea>
      <button class="btn-vocab" data-target="overallNote"> + เพิ่มคำศัพท์ </button>
    </div>
  </div>
  
  <div class="card">
    <h2>Defects</h2>
    <p class="hint">กรุณาระบุคะแนนหัก (Defect Deduction) เฉพาะแก้วที่มีเครื่องหมาย "Clean Cup" ถูกติ๊กไว้</p>
    <div id="defectDynamic"></div>
    <label for="defectNotes">บันทึก Defect</label>
    <div class="input-group">
      <textarea id="defectNotes" rows="3" placeholder="รายละเอียดของ defect เช่น phenolic, grassy, fermented"></textarea>
      <button class="btn-vocab" data-target="defectNotes"> + เพิ่มคำศัพท์ </button>
    </div>
  </div>

  <button class="btn btn-primary" id="btnFinish">➡️ ดูผลสรุปและคะแนนรวม</button>
</div>

<div id="summaryPage" class="hidden">
  <div id="summaryCard" class="summary-container">

    <div class="summary-card">
      <div class="summary-header">ข้อมูลทั่วไป</div>
      <p><b>ตัวอย่าง:</b> <span id="sumSample"></span></p>
      <p><b>Roast:</b> <span id="sumRoast"></span></p>
      <p><b>Acidity Level:</b> <span id="sumAcidityLevel"></span></p>
      <p><b>หมายเหตุ:</b> <span id="sumNotes"></span></p>
      <p><b>Defect notes:</b> <span id="sumDefect"></span></p>
    </div>

    <div class="summary-card" style="text-align: center;">
      <div class="summary-header">คะแนนรวมสุดท้าย (Final Score)</div>
      <div class="summary-score" id="finalScore">0.00</div>
      <div class="grade-tag" id="gradeTag"></div>
    </div>

    <div class="summary-card">
      <div class="summary-header">รายละเอียดคะแนน</div>
      <table class="summary-table">
        <thead>
          <tr>
            <th>หัวข้อ</th>
            <th>คะแนน</th>
            <th>บันทึก/รายละเอียด</th>
          </tr>
        </thead>
        <tbody id="scoreDetails"></tbody>
      </table>
    </div>

    <div class="summary-card">
      <div class="summary-header">สรุป Defects</div>
      <p id="defectSummary"></p>
    </div>

  </div>

  <div class="card">
    <h3>Export & Share</h3>
    <div class="export-buttons">
        <button class="btn btn-export" id="btnExportCSV">Export CSV</button>
        <button class="btn btn-export" id="btnExportTXT">Export TXT</button>
        <button class="btn btn-export" id="btnExportPDF">Export PDF</button>
        <button class="btn btn-export" id="btnExportPNG">Export PNG</button>
        <button class="btn btn-primary" id="btnShare">แชร์ผลลัพธ์</button>
        <button class="btn btn-text-copy" id="btnCopyText">คัดลอกข้อความ</button>
    </div>
  </div>
  <button class="btn btn-danger" id="btnBack">⬅️ ย้อนกลับไปแก้ไข</button>
</div>

<div id="vocabModal" class="modal-overlay hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h3>คลังคำศัพท์</h3>
      <button class="modal-close" id="closeModal">&times;</button>
    </div>
    <div class="vocab-categories" id="vocabCategories"></div>
    <div class="vocab-words" id="vocabWords"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const FIELDS = [
  {key:'fragrance',label:'Fragrance',isScore:true,note:'fragranceNote'},
  {key:'aroma',label:'Aroma',isScore:false,note:'aromaNote'},
  {key:'flavor',label:'Flavor',isScore:true,note:'flavorNote'},
  {key:'aftertaste',label:'Aftertaste',isScore:true,note:'aftertasteNote'},
  {key:'acidity',label:'Acidity',isScore:true,note:'acidityNote'},
  {key:'body',label:'Body',isScore:true,note:'bodyNote'},
  {key:'balance',label:'Balance',isScore:true,note:'balanceNote'},
  {key:'uniformity',label:'Uniformity',isCups:true,note:null},
  {key:'cleanCup',label:'Clean Cup',isCups:true,note:null},
  {key:'sweetness',label:'Sweetness',isCups:true,note:null},
  {key:'overall',label:'Overall',isScore:true,note:'overallNote'}
];

// NEW: Vocabulary Data based on SCA Flavor Wheel
const VOCABULARY = {
    "Fragrance/Aroma": [
        "Jasmine", "Rose", "Bergamot", "Lemon", "Orange", "Grapefruit", "Apricot", "Peach",
        "Blackberry", "Raspberry", "Strawberry", "Plum", "Cherry", "Apple", "Pear",
        "Cinnamon", "Clove", "Nutmeg", "Pepper", "Cardamom", "Vanilla", "Caramel",
        "Honey", "Maple Syrup", "Toffee", "Chocolate", "Nutty", "Almond", "Walnut",
        "Hazelnut", "Peanut", "Cereal", "Toasty", "Smoky", "Tobacco", "Pine", "Cedar",
        "Earthy", "Mushroom", "Rubber", "Burnt", "Ashy", "Sour", "Stale"
    ],
    "Flavor": [
        "Sweet", "Fruity", "Floral", "Citrus", "Berry", "Stone Fruit", "Apple/Pear",
        "Spice", "Nutty", "Cocoa", "Caramelized", "Roasted", "Smoky", "Earthy",
        "Herbaceous", "Grassy", "Peasy", "Malty", "Grainy", "Chocolate", "Vanilla",
        "Maple Syrup", "Honey", "Sour", "Bitter", "Acrid", "Medicinal"
    ],
    "Acidity": [
        "Citric Acid", "Malic Acid", "Lactic Acid", "Tartaric Acid", "Phosphoric Acid",
        "Bright", "Crisp", "Tangy", "Juicy", "Sparkling", "Clean", "Lively", "Sharp",
        "Dull", "Harsh"
    ],
    "Body": [
        "Light", "Watery", "Thin", "Silky", "Smooth", "Creamy", "Round", "Heavy",
        "Full-bodied", "Syrupy", "Buttery", "Viscous", "Coating", "Chalky", "Astringent"
    ],
    "Aftertaste": [
        "Clean", "Short", "Long", "Lingering", "Sweet", "Fruity", "Floral", "Caramelized",
        "Nutty", "Cocoa", "Bitter", "Astringent", "Sour", "Dry"
    ],
    "Overall": [
        "Complex", "Balanced", "Harmonious", "Sweetness", "Acidity", "Body", "Cleanliness",
        "Distinctive", "Exceptional", "Unique", "Well-developed"
    ],
    "Defect": [
      "Phenolic", "Grassy", "Earthy", "Rubbery", "Sour", "Fermented", "Musty", "Rioy", "Tainted", "Stale"
    ]
};

function getFormData() {
  const scores = {};
  const cupChecks = {};
  const notes = {};
  const defectScores = {};
  
  ['fragrance', 'flavor', 'aftertaste', 'acidity', 'body', 'balance', 'overall'].forEach(key => {
    scores[key] = parseFloat(document.getElementById(`${key}Score`).value) || 0;
  });

  ['fragranceNote', 'aromaNote', 'flavorNote', 'aftertasteNote', 'acidityNote', 'bodyNote', 'balanceNote', 'overallNote', 'notes', 'defectNotes'].forEach(key => {
    notes[key] = document.getElementById(key).value;
  });

  ['uniformity', 'cleanCup', 'sweetness'].forEach(key => {
    cupChecks[key] = [];
    for(let i = 1; i <= 5; i++) {
      cupChecks[key].push(document.getElementById(`${key}${i}`).checked ? 1 : 0);
    }
  });

  const defectSelects = document.getElementById('defectDynamic').querySelectorAll('select');
  defectSelects.forEach((select) => {
    const cupIndex = select.dataset.cupIndex;
    defectScores[cupIndex] = parseInt(select.value);
  });
  
  return {
    sampleId: document.getElementById('sampleId').value,
    roast: document.getElementById('roast').value,
    generalNotes: document.getElementById('notes').value,
    defectNotes: document.getElementById('defectNotes').value,
    acidityLevel: document.getElementById('acidityLevel').value,
    scores: scores,
    cupChecks: cupChecks,
    notes: notes,
    defectScores: defectScores
  };
}

function renderDefects() {
  const data = getFormData();
  const defectDynamicDiv = document.getElementById('defectDynamic');
  defectDynamicDiv.innerHTML = '';
  
  let hasDefectCups = false;

  for(let i = 1; i <= 5; i++) {
    if (document.getElementById(`cleanCup${i}`).checked) {
      hasDefectCups = true;
      const container = document.createElement('div');
      container.innerHTML = `
        <label>Defect แก้ว ${i}</label>
        <select data-cup-index="${i}">
          <option value="2">2 (Minor Defect)</option>
          <option value="4">4 (Major Defect)</option>
        </select>
      `;
      defectDynamicDiv.appendChild(container);
      
      const select = container.querySelector('select');
      const savedScore = data.defectScores[i] || 2;
      select.value = savedScore;
    }
  }
  
  if (!hasDefectCups) {
      defectDynamicDiv.innerHTML = '<p class="hint" style="color: var(--score-color);">ไม่มีแก้วที่ถูกระบุว่า "ไม่ใสสะอาด" (Clean Cup)</p>';
  }
}

for(let i = 1; i <= 5; i++) {
  document.getElementById(`cleanCup${i}`).addEventListener('change', renderDefects);
}
document.addEventListener('DOMContentLoaded', renderDefects);

function updateSummary() {
  const data = getFormData();
  
  let totalScore = 0;
  let defectDeduction = 0;
  
  const scoreKeys = ['fragrance', 'flavor', 'aftertaste', 'acidity', 'body', 'balance', 'overall'];
  scoreKeys.forEach(key => {
    totalScore += data.scores[key];
  });
  
  const cupCheckKeys = ['uniformity', 'cleanCup', 'sweetness'];
  cupCheckKeys.forEach(key => {
    totalScore += 10 - data.cupChecks[key].filter(v => v === 1).length * 2;
  });
  
  Object.values(data.defectScores).forEach(val => {
    defectDeduction += val;
  });
  
  const finalScore = totalScore - defectDeduction;
  const grade = finalScore >= 80 ? 'Specialty' : 'Not Specialty';
  const defectCount = data.cupChecks.cleanCup.filter(v => v === 1).length;
  
  document.getElementById('sumSample').textContent = data.sampleId || '-';
  document.getElementById('sumRoast').textContent = data.roast;
  document.getElementById('sumNotes').textContent = data.generalNotes || '-';
  document.getElementById('sumDefect').textContent = data.defectNotes || '-';
  document.getElementById('sumAcidityLevel').textContent = data.acidityLevel || '-';
  document.getElementById('finalScore').textContent = finalScore.toFixed(2);
  document.getElementById('gradeTag').textContent = grade;
  document.getElementById('gradeTag').style.backgroundColor = finalScore >= 80 ? 'var(--score-color)' : 'var(--low-score-color)';
  document.getElementById('finalScore').style.color = finalScore >= 80 ? 'var(--score-color)' : 'var(--low-score-color)';

  const scoreDetailsBody = document.getElementById('scoreDetails');
  scoreDetailsBody.innerHTML = '';

  const allFields = [
    {label:'Fragrance/Aroma',score:data.scores.fragrance,note:`${data.notes.fragranceNote || '-'} / ${data.notes.aromaNote || '-'}`},
    {label:'Flavor',score:data.scores.flavor,note:data.notes.flavorNote || '-'},
    {label:'Aftertaste',score:data.scores.aftertaste,note:data.notes.aftertasteNote || '-'},
    {label:'Acidity',score:data.scores.acidity,note:data.notes.acidityNote || '-'},
    {label:'Body',score:data.scores.body,note:data.notes.bodyNote || '-'},
    {label:'Balance',score:data.scores.balance,note:data.notes.balanceNote || '-'},
    {label:'Uniformity',score:10 - data.cupChecks.uniformity.filter(v=>v===1).length*2,note:data.cupChecks.uniformity.filter(v=>v===1).map( (v,i) => `แก้ว ${i+1}`).join(', ') || 'ทุกแก้วผ่าน'},
    {label:'Clean Cup',score:10 - data.cupChecks.cleanCup.filter(v=>v===1).length*2,note:data.cupChecks.cleanCup.filter(v=>v===1).map( (v,i) => `แก้ว ${i+1}`).join(', ') || 'ทุกแก้วผ่าน'},
    {label:'Sweetness',score:10 - data.cupChecks.sweetness.filter(v=>v===1).length*2,note:data.cupChecks.sweetness.filter(v=>v===1).map( (v,i) => `แก้ว ${i+1}`).join(', ') || 'ทุกแก้วผ่าน'},
    {label:'Overall',score:data.scores.overall,note:data.notes.overallNote || '-'}
  ];
  
  allFields.forEach(f => {
    const row = document.createElement('tr');
    row.innerHTML = `<td class="summary-table-cell">${f.label}</td><td class="summary-table-cell">${f.score.toFixed(2)}</td><td class="summary-table-cell">${f.note}</td>`;
    scoreDetailsBody.appendChild(row);
  });
  
  document.getElementById('defectSummary').textContent = `จำนวนแก้วที่ถูกระบุว่าไม่ใสสะอาด: ${defectCount} แก้ว. คะแนนหักรวม Defect: ${defectDeduction} คะแนน. (รายละเอียด Defect: ${data.defectNotes || '-'})`;
}

document.getElementById('btnFinish').addEventListener('click', () => {
  updateSummary();
  document.getElementById('formPage').classList.add('hidden');
  document.getElementById('summaryPage').classList.remove('hidden');
});

document.getElementById('btnBack').addEventListener('click', () => {
  document.getElementById('summaryPage').classList.add('hidden');
  document.getElementById('formPage').classList.remove('hidden');
});

function syncInputs(numId, rangeId) {
  const numInput = document.getElementById(numId);
  const rangeInput = document.getElementById(rangeId);
  numInput.addEventListener('input', () => rangeInput.value = numInput.value);
  rangeInput.addEventListener('input', () => numInput.value = rangeInput.value);
}
syncInputs('fragranceScore', 'fragranceRange');
syncInputs('flavorScore', 'flavorRange');
syncInputs('aftertasteScore', 'aftertasteRange');
syncInputs('acidityScore', 'acidityRange');
syncInputs('bodyScore', 'bodyRange');
syncInputs('balanceScore', 'balanceRange');
syncInputs('overallScore', 'overallRange');

function getFullSummaryText() {
  const data = getFormData();
  const { finalScore, grade } = getSummaryData();
  const defectDeduction = Object.values(data.defectScores).reduce((a,b)=>a+b,0);
  
  let text = `[SCA Cupping Score Summary]\n\n`;
  text += `Sample: ${data.sampleId || '-'}\nRoast: ${data.roast}\nAcidity Level: ${data.acidityLevel || '-'}\nNotes: ${data.generalNotes || '-'}\nDefect Notes: ${data.defectNotes || '-'}\n`;
  text += `\nFinal Score: ${finalScore.toFixed(2)} (${grade})\n`;
  text += `\n-- Score Details --\n`;
  
  text += `Fragrance/Aroma: ${data.scores.fragrance.toFixed(2)} (Note: ${data.notes.fragranceNote || '-'} / ${data.notes.aromaNote || '-'})\n`;
  text += `Flavor: ${data.scores.flavor.toFixed(2)} (Note: ${data.notes.flavorNote || '-'})\n`;
  text += `Aftertaste: ${data.scores.aftertaste.toFixed(2)} (Note: ${data.notes.aftertasteNote || '-'})\n`;
  text += `Acidity: ${data.scores.acidity.toFixed(2)} (Note: ${data.notes.acidityNote || '-'})\n`;
  text += `Body: ${data.scores.body.toFixed(2)} (Note: ${data.notes.bodyNote || '-'})\n`;
  text += `Balance: ${data.scores.balance.toFixed(2)} (Note: ${data.notes.balanceNote || '-'})\n`;
  
  text += `Uniformity: ${(10 - data.cupChecks.uniformity.filter(v=>v===1).length*2).toFixed(2)} (Failed Cups: ${data.cupChecks.uniformity.filter(v=>v===1).map( (v,i) => `Cup ${i+1}`).join(', ') || 'None'})\n`;
  text += `Clean Cup: ${(10 - data.cupChecks.cleanCup.filter(v=>v===1).length*2).toFixed(2)} (Failed Cups: ${data.cupChecks.cleanCup.filter(v=>v===1).map( (v,i) => `Cup ${i+1}`).join(', ') || 'None'})\n`;
  text += `Sweetness: ${(10 - data.cupChecks.sweetness.filter(v=>v===1).length*2).toFixed(2)} (Failed Cups: ${data.cupChecks.sweetness.filter(v=>v===1).map( (v,i) => `Cup ${i+1}`).join(', ') || 'None'})\n`;
  
  text += `Overall: ${data.scores.overall.toFixed(2)} (Note: ${data.notes.overallNote || '-'})\n`;
  
  text += `\n-- Defect Summary --\n`;
  text += `Defect Deduction Total: ${defectDeduction} points.\n`;
  Object.keys(data.defectScores).forEach(key => {
    text += `  Defect Cup ${key}: ${data.defectScores[key]} points deduction.\n`;
  });

  return text;
}

function getSummaryData() {
  const data = getFormData();
  let totalScore = 0;
  let defectDeduction = 0;
  
  const scoreKeys = ['fragrance', 'flavor', 'aftertaste', 'acidity', 'body', 'balance', 'overall'];
  scoreKeys.forEach(key => {
    totalScore += data.scores[key];
  });
  
  const cupCheckKeys = ['uniformity', 'cleanCup', 'sweetness'];
  cupCheckKeys.forEach(key => {
    totalScore += 10 - data.cupChecks[key].filter(v => v === 1).length * 2;
  });
  
  Object.values(data.defectScores).forEach(val => {
    defectDeduction += val;
  });
  
  const finalScore = totalScore - defectDeduction;
  const grade = finalScore >= 80 ? 'Specialty' : 'Not Specialty';
  return { finalScore, grade };
}

document.getElementById('btnExportCSV').onclick = () => {
  const data = getFormData();
  const { finalScore, grade } = getSummaryData();
  const defectCount = data.cupChecks.cleanCup.filter(v => v === 1).length;
  const defectDeduction = Object.values(data.defectScores).reduce((a,b)=>a+b,0);
  
  const headers = ['Sample','Roast','Notes','Defect Notes','Defect Count','Defect Deduction','AcidityLevel','Fragrance/Aroma Score','Fragrance Note','Aroma Note','Flavor Score','Flavor Note','Aftertaste Score','Aftertaste Note','Acidity Score','Acidity Note','Body Score','Body Note','Balance Score','Balance Note','Uniformity Score','Uniformity Failed Cups','Clean Cup Score','Clean Cup Failed Cups','Sweetness Score','Sweetness Failed Cups','Overall Score','Overall Note','Final Score','Grade'];
  
  const getFailedCups = (key) => data.cupChecks[key].map((v,i) => v === 1 ? `แก้ว ${i+1}` : null).filter(Boolean).join(', ') || 'ทุกแก้วผ่าน';

  const row = [
    `"${data.sampleId}"`,
    `"${data.roast}"`,
    `"${data.generalNotes.replace(/"/g, '""')}"`,
    `"${data.defectNotes.replace(/"/g, '""')}"`,
    defectCount,
    defectDeduction,
    `"${data.acidityLevel}"`,
    (data.scores.fragrance).toFixed(2),
    `"${data.notes.fragranceNote.replace(/"/g, '""')}"`,
    `"${data.notes.aromaNote.replace(/"/g, '""')}"`,
    (data.scores.flavor).toFixed(2),
    `"${data.notes.flavorNote.replace(/"/g, '""')}"`,
    (data.scores.aftertaste).toFixed(2),
    `"${data.notes.aftertasteNote.replace(/"/g, '""')}"`,
    (data.scores.acidity).toFixed(2),
    `"${data.notes.acidityNote.replace(/"/g, '""')}"`,
    (data.scores.body).toFixed(2),
    `"${data.notes.bodyNote.replace(/"/g, '""')}"`,
    (data.scores.balance).toFixed(2),
    `"${data.notes.balanceNote.replace(/"/g, '""')}"`,
    (10 - data.cupChecks.uniformity.filter(v=>v===1).length*2).toFixed(2),
    `"${getFailedCups('uniformity')}"`,
    (10 - data.cupChecks.cleanCup.filter(v=>v===1).length*2).toFixed(2),
    `"${getFailedCups('cleanCup')}"`,
    (10 - data.cupChecks.sweetness.filter(v=>v===1).length*2).toFixed(2),
    `"${getFailedCups('sweetness')}"`,
    (data.scores.overall).toFixed(2),
    `"${data.notes.overallNote.replace(/"/g, '""')}"`,
    finalScore.toFixed(2),
    `"${grade}"`
  ];
  
  const csv = '\ufeff' + headers.join(',') + "\n" + row.join(',');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `cupping_${data.sampleId || 'sample'}.csv`;
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('btnExportTXT').onclick = () => {
  const text = getFullSummaryText();
  const blob = new Blob([text],{type:'text/plain;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `cupping_${getFormData().sampleId || 'sample'}.txt`;
  a.click();
  URL.revokeObjectURL(url);
};

document.getElementById('btnCopyText').onclick = () => {
    const textToCopy = getFullSummaryText();
    navigator.clipboard.writeText(textToCopy)
        .then(() => alert("คัดลอกข้อความสรุปเรียบร้อยแล้วครับ!"))
        .catch(err => {
            console.error('Failed to copy text:', err);
            alert("ขออภัยค่ะ ไม่สามารถคัดลอกข้อความได้ กรุณาลองคัดลอกด้วยตนเอง");
        });
};


// [NEW] Improved image generation function that ensures table structure is rendered correctly.
function generateImageFromData() {
    const data = getFormData();
    const { finalScore, grade } = getSummaryData();
    const defectDeduction = Object.values(data.defectScores).reduce((a, b) => a + b, 0);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    const WIDTH = 1080;
    const padding = 60;
    const yIncrement = 30;

    // Define styles
    const BACKGROUND_COLOR = '#0d1117';
    const CARD_BACKGROUND = '#161b22';
    const BORDER_COLOR = '#30363d';
    const TEXT_COLOR = '#c9d1d9';
    const HEADING_COLOR = '#f0f6fc';
    const SCORE_COLOR = '#238636';
    const LOW_SCORE_COLOR = '#DA3633';
    
    // Fonts
    const FONT_NORMAL = '24px "Segoe UI", sans-serif';
    const FONT_BOLD = 'bold 26px "Segoe UI", sans-serif';
    const FONT_TITLE = 'bold 36px "Segoe UI", sans-serif';
    const FONT_SCORE = 'bold 80px "Segoe UI", sans-serif';
    const FONT_GRADE = 'bold 24px "Segoe UI", sans-serif';
    
    ctx.font = FONT_NORMAL;
    const measureText = (text) => ctx.measureText(text).width;
    
    // Pre-calculate heights for notes that might wrap
    const tableData = [
      {label:'Fragrance/Aroma',score:data.scores.fragrance,note:`${data.notes.fragranceNote || '-'} / ${data.notes.aromaNote || '-'}`},
      {label:'Flavor',score:data.scores.flavor,note:data.notes.flavorNote || '-'},
      {label:'Aftertaste',score:data.scores.aftertaste,note:data.notes.aftertasteNote || '-'},
      {label:'Acidity',score:data.scores.acidity,note:data.notes.acidityNote || '-'},
      {label:'Body',score:data.scores.body,note:data.notes.bodyNote || '-'},
      {label:'Balance',score:data.scores.balance,note:data.notes.balanceNote || '-'},
      {label:'Uniformity',score:10 - data.cupChecks.uniformity.filter(v=>v===1).length*2,note:data.cupChecks.uniformity.filter(v=>v===1).map( (v,i) => `แก้ว ${i+1}`).join(', ') || 'ทุกแก้วผ่าน'},
      {label:'Clean Cup',score:10 - data.cupChecks.cleanCup.filter(v=>v===1).length*2,note:data.cupChecks.cleanCup.filter(v=>v===1).map( (v,i) => `แก้ว ${i+1}`).join(', ') || 'ทุกแก้วผ่าน'},
      {label:'Sweetness',score:10 - data.cupChecks.sweetness.filter(v=>v===1).length*2,note:data.cupChecks.sweetness.filter(v=>v===1).map( (v,i) => `แก้ว ${i+1}`).join(', ') || 'ทุกแก้วผ่าน'},
      {label:'Overall',score:data.scores.overall,note:data.notes.overallNote || '-'}
    ];
    
    // Function to handle text wrapping and calculate height
    const wrapText = (text, maxWidth) => {
        const words = text.split(' ');
        let lines = [];
        let currentLine = '';
        words.forEach(word => {
            if (measureText(currentLine + ' ' + word) > maxWidth) {
                lines.push(currentLine.trim());
                currentLine = word + ' ';
            } else {
                currentLine += word + ' ';
            }
        });
        lines.push(currentLine.trim());
        return lines;
    };
    
    // Calculate content heights
    let yOffset = padding;
    const infoContentHeight = (data.generalNotes.split('\n').length + data.defectNotes.split('\n').length + 4) * yIncrement;
    yOffset += infoContentHeight + 100; // General info card height + padding
    yOffset += 250; // Final score card height + padding
    yOffset += 40; // 'รายละเอียดคะแนน' header
    
    const tableX = padding;
    const tableWidth = WIDTH - 2*padding;
    const col1Width = tableWidth * 0.25;
    const col2Width = tableWidth * 0.15;
    const col3Width = tableWidth * 0.60;
    const tableHeaderHeight = 40;
    
    let tableContentHeight = tableHeaderHeight;
    const wrappedNotes = [];
    tableData.forEach(f => {
        const lines = wrapText(f.note, col3Width - 20);
        wrappedNotes.push(lines);
        tableContentHeight += Math.max(40, lines.length * yIncrement);
    });
    
    yOffset += tableContentHeight;
    yOffset += 100; // Defect summary card height + padding
    yOffset += 50; // Footer
    
    const TOTAL_HEIGHT = yOffset;
    canvas.width = WIDTH;
    canvas.height = TOTAL_HEIGHT;
    
    // Start drawing
    ctx.fillStyle = BACKGROUND_COLOR;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw header
    let currentY = padding;
    ctx.fillStyle = HEADING_COLOR;
    ctx.font = FONT_TITLE;
    ctx.textAlign = 'center';
    ctx.fillText('SCA Cupping Score Summary', WIDTH / 2, currentY + 30);
    currentY += 80;
    
    // Draw General Info Card
    ctx.fillStyle = CARD_BACKGROUND;
    ctx.fillRect(padding - 20, currentY - 20, WIDTH - 2*padding + 40, infoContentHeight + 40);
    ctx.strokeStyle = BORDER_COLOR;
    ctx.lineWidth = 2;
    ctx.strokeRect(padding - 20, currentY - 20, WIDTH - 2*padding + 40, infoContentHeight + 40);

    ctx.fillStyle = HEADING_COLOR;
    ctx.font = FONT_BOLD;
    ctx.textAlign = 'left';
    ctx.fillText('ข้อมูลทั่วไป', padding, currentY);
    currentY += yIncrement;

    ctx.fillStyle = TEXT_COLOR;
    ctx.font = FONT_NORMAL;
    ctx.fillText(`ตัวอย่าง: ${data.sampleId || '-'}`, padding, currentY);
    currentY += yIncrement;
    ctx.fillText(`ระดับการคั่ว: ${data.roast || '-'}`, padding, currentY);
    currentY += yIncrement;
    ctx.fillText(`ความเป็นกรด: ${data.acidityLevel || '-'}`, padding, currentY);
    currentY += yIncrement;

    ctx.fillText(`หมายเหตุ:`, padding, currentY);
    currentY += yIncrement;
    wrapText(data.generalNotes || '-', col3Width).forEach(line => {
      ctx.fillText(line, padding, currentY);
      currentY += yIncrement;
    });

    ctx.fillText(`Defect notes:`, padding, currentY);
    currentY += yIncrement;
    wrapText(data.defectNotes || '-', col3Width).forEach(line => {
      ctx.fillText(line, padding, currentY);
      currentY += yIncrement;
    });
    
    currentY += 40; // Spacing after notes

    // Draw Final Score Card
    ctx.fillStyle = CARD_BACKGROUND;
    ctx.fillRect(padding - 20, currentY - 20, WIDTH - 2*padding + 40, 250);
    ctx.strokeStyle = BORDER_COLOR;
    ctx.strokeRect(padding - 20, currentY - 20, WIDTH - 2*padding + 40, 250);

    ctx.fillStyle = HEADING_COLOR;
    ctx.font = FONT_BOLD;
    ctx.textAlign = 'center';
    ctx.fillText('คะแนนรวมสุดท้าย (Final Score)', WIDTH / 2, currentY);
    currentY += 80;
    
    ctx.fillStyle = finalScore >= 80 ? SCORE_COLOR : LOW_SCORE_COLOR;
    ctx.font = FONT_SCORE;
    ctx.fillText(finalScore.toFixed(2), WIDTH / 2, currentY);

    currentY += 50;
    ctx.fillStyle = grade === 'Specialty' ? SCORE_COLOR : LOW_SCORE_COLOR;
    ctx.font = FONT_GRADE;
    ctx.fillText(grade, WIDTH / 2, currentY);
    currentY += 50;

    // Draw score details table
    ctx.fillStyle = HEADING_COLOR;
    ctx.font = FONT_BOLD;
    ctx.textAlign = 'left';
    ctx.fillText('รายละเอียดคะแนน', padding, currentY);
    currentY += 20;

    // Draw table headers
    ctx.fillStyle = BORDER_COLOR;
    ctx.fillRect(tableX, currentY, tableWidth, tableHeaderHeight);
    ctx.fillStyle = HEADING_COLOR;
    ctx.font = FONT_NORMAL;
    ctx.textAlign = 'left';
    ctx.fillText('หัวข้อ', tableX + 15, currentY + 28);
    ctx.fillText('คะแนน', tableX + col1Width + 15, currentY + 28);
    ctx.fillText('บันทึก/รายละเอียด', tableX + col1Width + col2Width + 15, currentY + 28);
    currentY += tableHeaderHeight;

    // Draw table rows
    tableData.forEach((f, index) => {
        const lines = wrappedNotes[index];
        const rowHeight = Math.max(40, lines.length * yIncrement + 10);
        
        ctx.fillStyle = index % 2 === 0 ? '#0d1117' : '#161b22';
        ctx.fillRect(tableX, currentY, tableWidth, rowHeight);
        
        ctx.fillStyle = TEXT_COLOR;
        ctx.font = FONT_NORMAL;
        
        // Draw text for each cell
        ctx.textAlign = 'left';
        ctx.fillText(f.label, tableX + 15, currentY + rowHeight / 2 + 8);
        ctx.fillText(f.score.toFixed(2), tableX + col1Width + 15, currentY + rowHeight / 2 + 8);

        lines.forEach((line, i) => {
            ctx.fillText(line, tableX + col1Width + col2Width + 15, currentY + 28 + (i * yIncrement));
        });
        
        // Draw grid lines
        ctx.strokeStyle = BORDER_COLOR;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(tableX + col1Width, currentY);
        ctx.lineTo(tableX + col1Width, currentY + rowHeight);
        ctx.moveTo(tableX + col1Width + col2Width, currentY);
        ctx.lineTo(tableX + col1Width + col2Width, currentY + rowHeight);
        ctx.moveTo(tableX, currentY);
        ctx.lineTo(tableX, currentY + rowHeight);
        ctx.moveTo(tableX + tableWidth, currentY);
        ctx.lineTo(tableX + tableWidth, currentY + rowHeight);
        ctx.stroke();
        
        currentY += rowHeight;
    });

    ctx.strokeStyle = BORDER_COLOR;
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(tableX, currentY);
    ctx.lineTo(tableX + tableWidth, currentY);
    ctx.stroke();

    currentY += 40;

    // Draw defect summary
    ctx.fillStyle = HEADING_COLOR;
    ctx.font = FONT_BOLD;
    ctx.textAlign = 'left';
    ctx.fillText('สรุป Defects', padding, currentY);
    currentY += yIncrement;
    ctx.fillStyle = TEXT_COLOR;
    ctx.font = FONT_NORMAL;
    const defectCount = data.cupChecks.cleanCup.filter(v => v === 1).length;
    const defectText = `จำนวนแก้วที่ถูกระบุว่าไม่ใสสะอาด: ${defectCount} แก้ว. คะแนนหักรวม Defect: ${defectDeduction} คะแนน.`;
    ctx.fillText(defectText, padding, currentY);
    currentY += yIncrement;
    wrapText(data.defectNotes || '-', col3Width).forEach(line => {
      ctx.fillText(`(รายละเอียด Defect: ${line})`, padding, currentY);
      currentY += yIncrement;
    });

    // Draw a professional footer
    currentY += 50;
    ctx.fillStyle = '#8B949E';
    ctx.font = '16px "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(`Generated by SCA Cupping Form on ${new Date().toLocaleDateString('th-TH', { dateStyle: 'long' })}`, WIDTH / 2, currentY);

    return canvas;
}

function dataURLtoBlob(dataurl) {
    var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
        bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
    while(n--){
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], {type:mime});
}

document.getElementById('btnExportPNG').onclick = () => {
  const btn = document.getElementById('btnExportPNG');
  const originalText = btn.textContent;
  btn.textContent = 'กำลังสร้างไฟล์...';

  const canvas = generateImageFromData();
  const link = document.createElement('a');
  link.download = `cupping_${getFormData().sampleId || 'sample'}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();

  btn.textContent = originalText;
};

document.getElementById('btnExportPDF').onclick = () => {
    const btn = document.getElementById('btnExportPDF');
    const originalText = btn.textContent;
    btn.textContent = 'กำลังสร้างไฟล์...';

    const canvas = generateImageFromData();

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4'); 
    const imgData = canvas.toDataURL('image/png');
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    
    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
    
    pdf.save(`cupping_${getFormData().sampleId || 'sample'}.pdf`);
    btn.textContent = originalText;
};

document.getElementById('btnShare').onclick = () => {
    const btn = document.getElementById('btnShare');
    const originalText = btn.textContent;
    btn.textContent = 'กำลังเตรียมข้อมูล...';

    const canvas = generateImageFromData();
    const shareText = getSummaryTextForShare();

    canvas.toBlob(blob => {
        const file = new File([blob], `cupping_${getFormData().sampleId || 'sample'}.jpg`, { type: 'image/jpeg' });
        const shareData = {
          title: 'SCA Cupping Result',
          text: shareText,
          files: [file]
        };
        
        if (navigator.share && navigator.canShare(shareData)) {
          navigator.share(shareData)
            .then(() => {
              btn.textContent = originalText;
              console.log('Shared successfully');
            })
            .catch(error => {
              console.error('File share failed, falling back to text:', error);
              shareData.files = []; 
              if (navigator.share) {
                  navigator.share(shareData)
                      .then(() => {
                          btn.textContent = originalText;
                          console.log('Text shared successfully');
                      })
                      .catch(err => {
                          btn.textContent = originalText;
                          console.error('Text share also failed:', err);
                          alert("ขออภัยค่ะ การแชร์ล้มเหลว กรุณาลองใหม่อีกครั้ง");
                      });
              } else {
                  btn.textContent = originalText;
                  alert("ขออภัยค่ะ เบราว์เซอร์หรืออุปกรณ์ของคุณไม่รองรับการแชร์ไฟล์");
              }
            });
        } else {
          btn.textContent = originalText;
          alert("ขออภัยค่ะ เบราว์เซอร์หรืออุปกรณ์ของคุณไม่รองรับ Web Share API");
        }
    }, 'image/jpeg');
};

function getSummaryTextForShare() {
    const data = getFormData();
    const { finalScore, grade } = getSummaryData();
    let text = `[SCA Cupping Score Summary]\n\n`;
    text += `Sample: ${data.sampleId || '-'}\nRoast: ${data.roast}\nFinal Score: ${finalScore.toFixed(2)} (${grade})\n`;
    text += `Notes: ${data.generalNotes || '-'} \n`;
    text += `Defect Notes: ${data.defectNotes || '-'}\n\n`;
    text += `รายละเอียด:\n`;
    text += ` - Fragrance/Aroma: ${data.scores.fragrance.toFixed(2)}\n`;
    text += ` - Flavor: ${data.scores.flavor.toFixed(2)}\n`;
    text += ` - Aftertaste: ${data.scores.aftertaste.toFixed(2)}\n`;
    text += ` - Acidity: ${data.scores.acidity.toFixed(2)}\n`;
    text += ` - Body: ${data.scores.body.toFixed(2)}\n`;
    text += ` - Balance: ${data.scores.balance.toFixed(2)}\n`;
    text += ` - Overall: ${data.scores.overall.toFixed(2)}\n`;
    text += `(ดูรายละเอียดเพิ่มเติมได้ในไฟล์ที่แนบ)`;
    return text;
}
// NEW: Vocabulary Modal Logic
let currentTextarea = null;

document.querySelectorAll('.btn-vocab').forEach(button => {
    button.addEventListener('click', (e) => {
        currentTextarea = document.getElementById(e.target.dataset.target);
        openModal(currentTextarea);
    });
});

document.getElementById('closeModal').addEventListener('click', closeModal);
document.getElementById('vocabModal').addEventListener('click', (e) => {
    if (e.target.id === 'vocabModal') {
        closeModal();
    }
});

function openModal(textarea) {
    document.getElementById('vocabModal').classList.add('active');
    renderCategories(textarea);
}

function closeModal() {
    document.getElementById('vocabModal').classList.remove('active');
}

function renderCategories(textarea) {
    const categoriesDiv = document.getElementById('vocabCategories');
    categoriesDiv.innerHTML = '';
    const categoryMapping = {
        'fragranceNote': 'Fragrance/Aroma',
        'aromaNote': 'Fragrance/Aroma',
        'flavorNote': 'Flavor',
        'aftertasteNote': 'Aftertaste',
        'acidityNote': 'Acidity',
        'bodyNote': 'Body',
        'balanceNote': 'Balance',
        'overallNote': 'Overall',
        'defectNotes': 'Defect'
    };
    
    // Get the primary category for the current textarea
    const primaryCategory = categoryMapping[textarea.id];
    
    Object.keys(VOCABULARY).forEach(category => {
        const btn = document.createElement('button');
        btn.className = 'vocab-category-btn';
        btn.textContent = category;
        btn.dataset.category = category;
        btn.addEventListener('click', () => {
            document.querySelectorAll('.vocab-category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderWords(category);
        });
        categoriesDiv.appendChild(btn);
    });

    // Automatically select the relevant category
    const primaryBtn = categoriesDiv.querySelector(`[data-category="${primaryCategory}"]`);
    if (primaryBtn) {
      primaryBtn.click();
    } else {
      document.querySelector('.vocab-category-btn').click(); // Fallback to first category
    }
}

function renderWords(category) {
    const wordsDiv = document.getElementById('vocabWords');
    wordsDiv.innerHTML = '';
    
    VOCABULARY[category].forEach(word => {
        const item = document.createElement('span');
        item.className = 'vocab-word-item';
        item.textContent = word;
        item.dataset.word = word;
        item.tabIndex = 0; // Make it focusable
        item.addEventListener('click', () => {
            insertWord(word);
        });
        item.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                insertWord(word);
            }
        });
        wordsDiv.appendChild(item);
    });
}

function insertWord(word) {
    if (currentTextarea) {
        const currentText = currentTextarea.value.trim();
        if (currentText.length > 0 && !currentText.endsWith(',')) {
            currentTextarea.value += `, ${word}`;
        } else if (currentText.length > 0) {
            currentTextarea.value += ` ${word}`;
        } else {
            currentTextarea.value += word;
        }
        closeModal();
        currentTextarea.focus();
    }
}
</script>
</body>
</html>